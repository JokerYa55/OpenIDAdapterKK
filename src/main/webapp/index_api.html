<!DOCTYPE html>
<html>
    <head>
        <title>Личный кабинет</title>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="style.css">
        <script  src="script.js"></script>
        <script src="jquery-3.2.1.js"></script>

        <script>
            //var userInfo;
            //var accessToken;
            console.groupCollapsed("index_api");
            var kc = {};
            $(document).ready(function () {
                console.log("document.redy");

                var initPromise = initApp(kc);

                initPromise.then(data => {
                    // 
                    console.group("main => initPromise => then");
                    console.log(data);

                    kc.host = data["auth-server-url"];
                    //"http://192.168.1.150:8080";
                    kc.realm = data["realm"];
                    //"videomanager";
                    kc.clientId = data["resource"];
                    //"video-app";
                    kc.clientSecret = data["credentials"]["secret"];
                    //"50c93bab-fe8f-422a-948e-a63c52458ee3";
                    kc.access_token = getCookie("access_token");
                    kc.id_token = getCookie("id_token");
                    kc.refresh_token = getCookie("refresh_token");
                    kc.session_state = getCookie("session_state");
                    kc.refresh_expires_in = getCookie("refresh_expires_in");
                    kc.expires_in = getCookie("expires_in");
                    kc.username = getCookie("username");

                    console.log("kc global = ");
                    console.log(kc);
                    console.log("kc.access_token = %s", kc.access_token);
                    if (kc["access_token"] === undefined) {
                        console.log("Куки не установлены");
                        // Выводим сообщение что нужно авторизоваться
                        alert("Пожалуйста авторизуйтесь !!!");
                    } else
                    {
                        var username = "appuser";
                        // Получаем инфо user-a                    
                        var userInfoPromise = getUserInfo(username, kc.host, kc.realm, kc.access_token);
                        userInfoPromise.then(function (data) {
                            console.log(data);
                        });
                    }

                    console.groupEnd();

                }).catch(err => {
                    console.group("initApp => initPromise => catch");
                    console.error(err);
                    console.groupEnd();
                });

                //kc.tableName = "rtkPasportParams"; // Имя таблицы 
                //kc.columnName = "f_name";
                //kc.columnVal = "f_val";
                //kc.sqlStorage = null; // Локальное sqlStorage хранилище
                //kc.sqlStorage = initSqlStorage();
                //initSqlShema(kc.sqlStorage);
                //kc.access_token = getCookie("access_token");


                console.groupEnd();
            });


            function userLoginLocal() {
                console.group("userLogin()");
                var username = $("#nameId").val();
                var password = $("#passwordId").val();
                userLogin(username, password, kc);
                console.groupEnd();
            }

            /** 
             * Logout
             */
           
            console.groupEnd();
        </script>    
    </head>
    <body>
        <div id="idLoginMain">
            <div id="header">
                <div id="idUserInfo">

                </div>
            </div>
            <div id="idLoginForm">
                <div id="idLogin">
                    <form>                
                        <table>
                            <tr>
                                <td>
                                    Имя
                                </td>
                                <td>
                                    <input id="nameId" type="text" name="username" value="appuser"/>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Пароль
                                </td>
                                <td>
                                    <input id="passwordId" type="text" name="password" value="123"/> 
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input type="button" value="Вход" onclick="userAuth();"/>                
                                </td>
                                <td>
                                    <input type="button" value="Выход" onclick="userCloseAuth(kc.host, kc.realm, kc.clientId, kc.userId, kc.access_token);"/>                
                                </td>
                            </tr>
                        </table>
                        <input id="idId" type="text" value=" ">

                        <input type="button" value="Информация" onclick="getUserInfo('appuser', kc.host, kc.realm, kc.access_token);"/> 
                        <input type="button" value="Auth" onclick="userLoginLocal();"/> 
                    </form>
                </div>           
            </div>
        </div>
        <div id="content">
            <table id="idDataTable">
                <tbody>

                </tbody>
            </table>
        </div>

        <button onclick="getTokenInfo()">Получить информацию</button>

        <div id="idContaner">
            <div id="idTokenInfo">

            </div>
        </div>
        <button onclick="getOpenIDInfo();">Инфо</button>
    </body>
</body>
</html>
