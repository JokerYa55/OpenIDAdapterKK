<!DOCTYPE html>
<html>
    <head>
        <title>Личный кабинет</title>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="style.css">
        <script  src="script.js"></script>
        <script src="jquery-3.2.1.js"></script>

        <script>
            //var userInfo;
            //var accessToken;

            $(document).ready(function () {
                console.log("document.redy");
                var kc = {};
                kc.host = "http://192.168.1.150:8080";
                kc.realm = "videomanager";
                kc.clientId = "video-app";
                kc.clientSecret = "50c93bab-fe8f-422a-948e-a63c52458ee3";
                kc.sqlStorage = null; // Локальное sqlStorage хранилище
                kc.tableName = "rtkPasportParams"; // Имя таблицы 
                kc.columnName = "f_name";
                kc.columnVal = "f_val";
                kc.access_token = "";
                //kc.sqlStorage = initSqlStorage();
                //initSqlShema(kc.sqlStorage);

                kc.access_token = getCookie("access_token");

                if (kc.access_token === undefined) {
                    console.log("Куки не установлены");
                    // Выводим сообщение что нужно авторизоваться
                    alert("Пожалуйста авторизуйтесь !!!");
                } else
                {
                    var username = "appuser";
                    console.log("kc = ");
                    console.log(kc);
                    // Получаем инфо user-a                    
                    var userInfoPromise = getUserInfo(username, kc.host, kc.realm, kc.access_token);
                    userInfoPromise.then(function (data) {
                        console.log(data);
                    });
                }
                console.groupEnd();
            });


            function userLoginLocal() {
                console.group("userLogin()");
                var username = $("#nameId").val();
                var password = $("#passwordId").val();
                userLogin(username, password);
                console.groupEnd();
            }

            /** 
             * Logout
             */
            function userCloseAuth()
            {
                ///realms/master/protocol/openid-connect/logout
                console.group("userNoAuth()");
                try {
                    $.ajax({
                        url: host + "/auth/realms/" + realm + "/protocol/openid-connect/logout",
                        type: "POST",
                        data: {refresh_token: accessToken.refresh_token,
                            client_id: clientId},
                        headers: {'Authorization': "Bearer " + accessToken.access_token,
                            'Content-Type': "application/x-www-form-urlencoded"},
                        /*beforeSend: function (xhr) {
                         xhr.setRequestHeader('Authorization', "Bearer " + accessToken.access_token);
                         xhr.setRequestHeader('Content-Type', "application/x-www-form-urlencoded");
                         xhr.setRequestHeader('Payload', "refresh_token=" + accessToken.refresh_token);
                         },*/
                        success: function (data) {
                            console.groupCollapsed("userNoAuth -> success");
                            console.log("Session close");
                            console.log(data);
                            accessToken = new Object();
                            console.log(accessToken);
                            console.groupEnd();
                            deleteCookie("access_token");
                            $("#idUserInfo").html("<p>До свидания: " + userInfo.firstName + " " + userInfo.lastName + "</p>");
                            // Очищаем таблицу
                            $("#idDataTable>tbody:last-child").empty();
                        }
                    });
                } catch (exception) {
                    console.log(exception);
                }

                console.groupEnd();
            }

            //action="http://192.168.1.150:8080/auth/realms/master/protocol/openid-connect/token" method="POST"
        </script>    
    </head>
    <body>
        <div id="idLoginMain">
            <div id="header">
                <div id="idUserInfo">

                </div>
            </div>
            <div id="idLoginForm">
                <div id="idLogin">
                    <form>                
                        <table>
                            <tr>
                                <td>
                                    Имя
                                </td>
                                <td>
                                    <input id="nameId" type="text" name="username" value="appuser"/>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Пароль
                                </td>
                                <td>
                                    <input id="passwordId" type="text" name="password" value="123"/> 
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input type="button" value="Вход" onclick="userAuth();"/>                
                                </td>
                                <td>
                                    <input type="button" value="Выход" onclick="userCloseAuth();"/>                
                                </td>
                            </tr>
                        </table>
                        <input id="idId" type="text" value=" ">

                        <input type="button" value="Информация" onclick="getUserInfo('appuser', kc.host, kc.realm, kc.access_token);"/> 
                        <input type="button" value="Auth" onclick="userLoginLocal();"/> 
                    </form>
                </div>           
            </div>
        </div>
        <div id="content">
            <table id="idDataTable">
                <tbody>

                </tbody>
            </table>
        </div>

        <button onclick="getTokenInfo()">Получить информацию</button>

        <div id="idContaner">
            <div id="idTokenInfo">

            </div>
        </div>
        <button onclick="getOpenIDInfo();">Инфо</button>
    </body>
</body>
</html>
